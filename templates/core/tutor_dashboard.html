{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="card">
  <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div>
      <h2 class="card-title">{% trans "Tutor Dashboard" %}</h2>
      <p class="card-subtitle" style="margin:6px 0 0;">
        {% trans "When you go online, you’ll be available for 5-minute lesson matching." %}
      </p>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
      {% if tutor.is_online %}
        <span class="badge badge-green" id="status-badge">{% trans "Online" %}</span>
      {% else %}
        <span class="badge badge-gray" id="status-badge">{% trans "Offline" %}</span>
      {% endif %}
    </div>
  </div>

  <!-- Status panel -->
  <div class="mt-16" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
    <div>
      <div style="font-weight:600; font-size:1.05rem;">
        {% if tutor.is_online %}
          {% trans "You are discoverable now." %}
        {% else %}
          {% trans "You are not discoverable." %}
        {% endif %}
      </div>
      <div class="text-muted" style="margin-top:6px;" id="matching-hint">
        {% if tutor.is_online %}
          {% trans "Waiting for a student… We’ll move you to the lesson room automatically when matched." %}
        {% else %}
          {% trans "Switch online to start matching." %}
        {% endif %}
      </div>
    </div>

    <!-- Toggle (submit form) -->
    <form method="post" id="online-form" style="margin:0;">
      {% csrf_token %}
      {% if tutor.is_online %}
        <input type="hidden" name="action" value="go_offline">
      {% else %}
        <input type="hidden" name="action" value="go_online">
      {% endif %}

      <label class="switch" style="display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;">
        <span class="text-muted" style="min-width:72px; text-align:right;">{% trans "Offline" %}</span>
        <span class="switch-track" aria-hidden="true">
          <span class="switch-thumb"></span>
        </span>
        <span class="text-muted" style="min-width:72px;">{% trans "Online" %}</span>

        {# 本体は見せないcheckbox。クリックでsubmitさせる #}
        <input id="online-toggle" type="checkbox" style="display:none;" {% if tutor.is_online %}checked{% endif %}>
      </label>
    </form>
  </div>

  <!-- matching spinner (online時だけ表示) -->
  <div id="matching-row" class="mt-16" style="display:none; align-items:center; gap:10px;">
    <span class="spinner" aria-hidden="true"></span>
    <span class="text-muted">{% trans "Matching in progress…" %}</span>
  </div>
</div>

<!-- 最近担当したレッスン（別ファイル化） -->
{% include "core/_recent_lessons.html" with matches=matches dummy_matches=dummy_matches %}

<style>
  /* Simple “pro” toggle */
  .switch-track{
    position:relative;
    width:56px;
    height:30px;
    border-radius:999px;
    background:#e5e7eb; /* gray-200 */
    display:inline-block;
    transition:background .2s ease;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.06);
  }
  .switch-thumb{
    position:absolute;
    top:3px;
    left:3px;
    width:24px;
    height:24px;
    border-radius:999px;
    background:white;
    transition:transform .2s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.12);
  }
  /* checked state (we’ll sync via JS) */
  .is-online .switch-track{ background:#16a34a; } /* green-600 */
  .is-online .switch-thumb{ transform: translateX(26px); }

  /* spinner */
  .spinner{
    width:16px; height:16px; border-radius:50%;
    border:2px solid rgba(0,0,0,.15);
    border-top-color: rgba(0,0,0,.55);
    display:inline-block;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
(function(){
  const form = document.getElementById("online-form");
  const toggle = document.getElementById("online-toggle");
  const rootCard = form.closest(".card");
  const matchingRow = document.getElementById("matching-row");

  // 初期状態反映
  function applyUI(isOnline){
    if (isOnline) {
      rootCard.classList.add("is-online");
      matchingRow.style.display = "flex";
    } else {
      rootCard.classList.remove("is-online");
      matchingRow.style.display = "none";
    }
  }
  applyUI(toggle.checked);

  // スイッチクリックでPOST（オンライン/オフライン切替）
  rootCard.querySelector(".switch-track").addEventListener("click", () => form.submit());
  rootCard.querySelector(".switch-thumb").addEventListener("click", () => form.submit());

  // ===== 自動マッチング：オンラインの時だけポーリングして match があれば lesson_roomへ =====
  const isOnline = {{ tutor.is_online|yesno:"true,false" }};
  if (!isOnline) return;

  async function poll(){
    try{
      const res = await fetch(pollUrl, { headers: { "X-Requested-With": "XMLHttpRequest" }});
      if (!res.ok) throw new Error("poll failed");
      const data = await res.json();

      // { found: true, redirect_url: "/lesson/123/" } を想定
      if (data.found && data.redirect_url) {
        window.location.href = data.redirect_url;
        return;
      }
    } catch(e){
      // 失敗しても静かに継続
      console.log(e);
    }
    setTimeout(poll, 2000); // 2秒ごと
  }
  poll();
})();
</script>
{% endblock %}
